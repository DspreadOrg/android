name: Android CI/CD

on:
  push:
    branches:
      - master  # è§¦å‘ CI/CD çš„åˆ†æ”¯
  pull_request:
    branches:
      - master  # ç›‘å¬åˆ° PR åˆ° main åˆ†æ”¯æ—¶è§¦å‘ CI/CD

jobs:
  lint:
    runs-on: ubuntu-latest  # ä½¿ç”¨ Ubuntu ä½œä¸ºè¿è¡Œç¯å¢ƒ

    steps:
      - name: Check out repository
        uses: actions/checkout@v2  # æ£€å‡ºå½“å‰ä»“åº“ä»£ç 

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 16

      - name: Install commitlint
        run: |
          npm install -g @commitlint/cli @commitlint/config-conventional

      - name: Run commitlint
        run: |
          if [ "${GITHUB_SHA}" = "0000000000000000000000000000000000000000" ]; then
            echo "commitlint from HEAD^"
            npx commitlint -x @commitlint/config-conventional -f HEAD^
          else
            echo "commitlint from ${GITHUB_SHA}"
            npx commitlint -x @commitlint/config-conventional -f "${GITHUB_SHA}"
          fi

  build:
    runs-on: ubuntu-latest  # ä½¿ç”¨ Ubuntu ä½œä¸ºè¿è¡Œç¯å¢ƒ

    steps:
      - name: Check out repository
        uses: actions/checkout@v3  # æ£€å‡ºå½“å‰ä»“åº“ä»£ç 

      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'zulu'  # æŒ‡å®š Java å‘è¡Œç‰ˆ

      - name: Set up Android SDK
        uses: android-actions/setup-android@v2
        with:
          api-level: 30
          build-tools: 30.0.3

      #  ç¼“å­˜ Gradle ä¾èµ–é¡¹
      - name: Cache Gradle packages
        uses: actions/cache@v3
        with:
          path: ~/.gradle/caches
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-


      - name: Get version information
        id: version
        run: |
          VERSION_CODE=$(grep versionCode pos_android_studio_demo/pos_android_app/build.gradle | head -n 1 | sed 's/.*versionCode\s*\([0-9]\+\).*/\1/')
          VERSION_NAME=$(grep versionName pos_android_studio_demo/pos_android_app/build.gradle | head -n 1 | sed 's/.*versionName\s*"\([^"]\+\)".*/\1/')
          echo "VERSION_CODE=$VERSION_CODE" >> $GITHUB_ENV
          echo "VERSION_NAME=$VERSION_NAME" >> $GITHUB_ENV  

      - name: Get commit message
        id: commit
        run: |
          COMMIT_MESSAGE=$(git log -1 --pretty=%B)
          COMMIT_MESSAGE=$(echo "$COMMIT_MESSAGE" | sed 's/^[0-9]\+\.[ ]*//g')
          COMMIT_MESSAGE=$(echo "$COMMIT_MESSAGE" | tr -d '\n')
          echo "COMMIT_MESSAGE=$COMMIT_MESSAGE" >> $GITHUB_ENV

       #  è§£ç å¹¶ä¿å­˜ keystore æ–‡ä»¶
      - name: Decode and Save Keystore
        run: |
          echo "${{ vars.KEYSTORE_FILE }}" | base64 -d > pos_android_studio_demo/app.keystore

      - name: Build the release signed APK
        run: |
            cd pos_android_studio_demo
            chmod +x ./gradlew
            ./gradlew assembleRelease \
            -Pandroid.injected.signing.store.file=app.keystore \
            -Pandroid.injected.signing.store.password=${{ vars.KEYSTORE_PASSWORD }} \
            -Pandroid.injected.signing.key.alias=${{ vars.KEY_ALIAS }} \
            -Pandroid.injected.signing.key.password=${{ vars.KEY_PASSWORD }}

      # ä¿å­˜ç”Ÿæˆçš„ APK æ–‡ä»¶
      - name: Upload APK Artifact
        uses: actions/upload-artifact@v4
        with:
          name: pos_android_app-release
          path: pos_android_studio_demo/pos_android_app/build/outputs/apk/release/pos_android_app-release.apk

      - name: List APK files
        run: ls -R pos_android_studio_demo/pos_android_app/build/outputs/apk/release  # åˆ—å‡º APK æ–‡ä»¶ï¼Œç¡®ä¿è·¯å¾„æ­£ç¡®

        # ä¿å­˜SDK åº“æ–‡ä»¶
      - name: Upload SDK Artifact
        uses: actions/upload-artifact@v4
        with:
          name: dspread-sdks
          path: |
            pos_android_studio_demo/pos_android_app/libs/dspread_pos_sdk_*.aar
            pos_android_studio_demo/pos_android_app/libs/dspread_print_sdk-*.aar  
      
  release:
    runs-on: ubuntu-latest
    needs: [build]  # ä¾èµ–äº build ä½œä¸šçš„æˆåŠŸ

    steps:
      - name: Check out repository
        uses: actions/checkout@v3

      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
      - name: Get version information
        id: version
        run: |
          VERSION_CODE=$(grep versionCode pos_android_studio_demo/pos_android_app/build.gradle | head -n 1 | sed 's/.*versionCode\s*\([0-9]\+\).*/\1/')
          VERSION_NAME=$(grep versionName pos_android_studio_demo/pos_android_app/build.gradle | head -n 1 | sed 's/.*versionName\s*"\([^"]\+\)".*/\1/')
          echo "VERSION_CODE=$VERSION_CODE" >> $GITHUB_ENV
          echo "VERSION_NAME=$VERSION_NAME" >> $GITHUB_ENV
          echo "TAG_NAME=v$VERSION_NAME" >> $GITHUB_ENV
          
          BUILD_ID="$VERSION_NAME-$VERSION_CODE-$(date +%Y%m%d)"
          echo "BUILD_ID=$BUILD_ID" >> $GITHUB_ENV

      - name: Check if release already exists
        id: check_release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          RESPONSE=$(curl -s -H "Authorization: token $GITHUB_TOKEN" \
            "https://api.github.com/repos/${{ github.repository }}/releases/tags/$TAG_NAME" || echo "NOT_FOUND")
          
          if [[ "$RESPONSE" != "NOT_FOUND" ]] && echo "$RESPONSE" | grep -q '"id":'; then
            echo "Release $TAG_NAME already exists. Skipping release creation."
            echo "RELEASE_EXISTS=true" >> $GITHUB_ENV
            
            EXISTING_NAME=$(echo "$RESPONSE" | grep '"name"' | head -1 | cut -d'"' -f4)
            echo "EXISTING_RELEASE_NAME=$EXISTING_NAME" >> $GITHUB_ENV
          else
            echo "Release $TAG_NAME does not exist. Proceeding with release creation."
            echo "RELEASE_EXISTS=false" >> $GITHUB_ENV
          fi

      - name: Download APK Artifact
        if: env.RELEASE_EXISTS == 'false'
        uses: actions/download-artifact@v4
        with:
          name: pos_android_app-release
          path: pos_android_studio_demo/pos_android_app/build/outputs/apk/release

      - name: Verify APK file in release
        if: env.RELEASE_EXISTS == 'false'
        run: ls -R pos_android_studio_demo/pos_android_app/build/outputs/apk/release  # åˆ—å‡º APK æ–‡ä»¶ï¼Œç¡®ä¿è·¯å¾„æ­£ç¡®

      - name: Verify SDK Files
        if: env.RELEASE_EXISTS == 'false'
        id: verify-sdk
        run: |
             POS_SDKS=$(find pos_android_studio_demo/pos_android_app/libs -name "dspread_pos_sdk_*.aar" -type f | tr '\n' ' ')
             PRINT_SDKS=$(find pos_android_studio_demo/pos_android_app/libs -name "dspread_print_sdk-*.aar" -type f | tr '\n' ' ')
            
             # æ‰“å°éªŒè¯ç»“æœ
             echo "Found POS SDK files: $POS_SDKS"
             echo "Found PRINT SDK files: $PRINT_SDKS"
            
             # æ£€æŸ¥æ˜¯å¦æ‰¾åˆ°æ–‡ä»¶
             if [ -z "$POS_SDKS" ]; then
               echo "WARNING: No POS SDK files found!"
             else
               # ç»Ÿè®¡æ‰¾åˆ°çš„æ–‡ä»¶æ•°é‡
               POS_COUNT=$(echo "$POS_SDKS" | wc -w)
               echo "Found $POS_COUNT POS SDK file(s)"
             fi
            
             if [ -z "$PRINT_SDKS" ]; then
               echo "WARNING: No PRINT SDK files found!"
             else
               PRINT_COUNT=$(echo "$PRINT_SDKS" | wc -w)
               echo "Found $PRINT_COUNT PRINT SDK file(s)"
             fi
            
             # è®¾ç½®è¾“å‡ºå˜é‡ï¼ˆæ³¨æ„ï¼šæ¯ä¸ªè¾“å‡ºå˜é‡éƒ½è¦å•ç‹¬è®¾ç½®ï¼‰
             echo "pos_sdks=$POS_SDKS" >> $GITHUB_OUTPUT
             echo "print_sdks=$PRINT_SDKS" >> $GITHUB_OUTPUT

      - name: Get commit message
        if: env.RELEASE_EXISTS == 'false'
        id: commit
        run: |
          COMMIT_MESSAGE=$(git log -1 --pretty=%B)
          COMMIT_MESSAGE=$(echo "$COMMIT_MESSAGE" | sed 's/^[0-9]\+\.[ ]*//g')
          COMMIT_MESSAGE=$(echo "$COMMIT_MESSAGE" | tr -d '\n')
          echo "COMMIT_MESSAGE=$COMMIT_MESSAGE" >> $GITHUB_ENV

      - name: Create GitHub Release
        if: env.RELEASE_EXISTS == 'false'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ env.TAG_NAME }}
          name: v${{ env.VERSION_NAME }}
          body: |
            ${{ env.VERSION_NAME }}
            
            **Changes:**
            ${{ env.COMMIT_MESSAGE }}
          draft: false
          prerelease: false
          files: |
            pos_android_studio_demo/pos_android_app/build/outputs/apk/release/pos_android_app-release.apk
            ${{ steps.verify-sdk.outputs.pos_sdks }}
            ${{ steps.verify-sdk.outputs.print_sdks }}
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Skip release creation
        if: env.RELEASE_EXISTS == 'true'
        run: |
          echo "ğŸš« Release ${{ env.TAG_NAME }} already exists!"
          echo "ğŸ“‹ Existing Release: ${{ env.EXISTING_RELEASE_NAME }}"
          echo "ğŸ’¡ If you want to create a new release, please update versionCode and versionName in build.gradle"

  upload-to-gitlab-maven:
  runs-on: ubuntu-latest
  needs: [build]  # ä¾èµ–äº build ä½œä¸šæˆåŠŸ
  # if: github.event_name == 'push' && github.ref == 'refs/heads/master'  # ä»…å½“æ¨é€åˆ° master åˆ†æ”¯æ—¶æ‰§è¡Œ
  
  steps:
    - name: Check out repository
      uses: actions/checkout@v3
      
    - name: Set up Maven
      uses: actions/setup-java@v3
      with:
        java-version: '17'
        distribution: 'temurin'
        
    - name: Configure Maven for GitLab
      run: |
        mkdir -p ~/.m2
        cat > ~/.m2/settings.xml <<EOF
        <settings>
          <servers>
            <server>
              <id>gitlab-maven</id>
              <configuration>
                <httpHeaders>
                  <property>
                    <name>Deploy-Token</name>
                    <value>${{ secrets.GITLAB_DEPLOY_TOKEN }}</value>
                  </property>
                </httpHeaders>
              </configuration>
            </server>
          </servers>
        </settings>
        EOF
        
    - name: Upload POS SDK AARs to GitLab Maven
      env:
        GITLAB_MAVEN_URL: ${{ secrets.GITLAB_MAVEN_URL }}
        GITLAB_DEPLOY_TOKEN: ${{ secrets.GITLAB_DEPLOY_TOKEN }}
      run: |
        # è®¾ç½®å·¥ä½œç›®å½•
        AAR_DIR="pos_android_studio_demo/pos_android_app/libs"
        
        echo "ğŸ” æŸ¥æ‰¾ POS SDK AAR æ–‡ä»¶..."
        
        # åªä¸Šä¼ åŒ¹é… dspread_pos_sdk_*.aar çš„æ–‡ä»¶
        for aar_file in "$AAR_DIR"/dspread_pos_sdk_*.aar; do
          if [ ! -f "$aar_file" ]; then
            echo "âš ï¸  æœªæ‰¾åˆ°åŒ¹é…çš„ POS SDK AAR æ–‡ä»¶"
            continue
          fi
          
          echo "ğŸ“¦ å¤„ç†æ–‡ä»¶: $aar_file"
          
          # æå–æ–‡ä»¶åå’ŒåŸºæœ¬ä¿¡æ¯
          filename=$(basename "$aar_file")
          name="${filename%.*}"  # å»æ‰ .aar åç¼€
          
          echo "ğŸ“„ æ–‡ä»¶å: $filename"
          echo "ğŸ†” åç§°: $name"
          
          # æå–ç‰ˆæœ¬å·å’Œå˜ä½“ä¿¡æ¯
          # åŒ¹é…æ¨¡å¼: dspread_pos_sdk_8.2.7.aar æˆ– dspread_pos_sdk_8.2.7-min.aar
          if [[ "$name" =~ ^dspread_pos_sdk_([0-9]+\.[0-9]+\.[0-9]+)(-min)?$ ]]; then
            version="${BASH_REMATCH[1]}"      # 8.2.7
            suffix="${BASH_REMATCH[2]:-}"     # -min æˆ–ç©º
            
            # è®¾ç½® Maven åæ ‡
            groupId="com.dspread.library"
            
            if [ -n "$suffix" ]; then
              # å¦‚æœæœ‰ -min åç¼€
              artifactId="dspread_pos_sdk"
              version="${BASH_REMATCH[1]}-min" 
              echo "ğŸ¯ æ£€æµ‹åˆ° POS SDK ç²¾ç®€ç‰ˆ: version=$version"
            else
              # å®Œæ•´ç‰ˆ
              artifactId="dspread_pos_sdk"
              version="${BASH_REMATCH[1]}"
              echo "ğŸ¯ æ£€æµ‹åˆ° POS SDK å®Œæ•´ç‰ˆ: version=$version"
            fi
            
            echo "ğŸ“¦ Maven åæ ‡:"
            echo "  groupId: $groupId"
            echo "  artifactId: $artifactId"
            echo "  version: $version"
            echo "  packaging: aar"
            
            # éªŒè¯å¿…è¦ä¿¡æ¯
            if [ -z "$GITLAB_MAVEN_URL" ]; then
              echo "âŒ é”™è¯¯: GITLAB_MAVEN_URL æœªè®¾ç½®"
              exit 1
            fi
            
            if [ -z "$GITLAB_DEPLOY_TOKEN" ]; then
              echo "âŒ é”™è¯¯: GITLAB_DEPLOY_TOKEN æœªè®¾ç½®"
              exit 1
            fi
            
            echo "ğŸŒ GitLab Maven URL: $GITLAB_MAVEN_URL"
            
            # æ–¹æ³•1: ä½¿ç”¨ Maven deploy å‘½ä»¤ï¼ˆæ¨èï¼‰
            echo "ğŸš€ ä½¿ç”¨ Maven deploy ä¸Šä¼ ..."
            
            mvn deploy:deploy-file \
              -Dfile="$aar_file" \
              -DgroupId="$groupId" \
              -DartifactId="$artifactId" \
              -Dversion="$version" \
              -Dpackaging="aar" \
              -DrepositoryId="gitlab-maven" \
              -Durl="$GITLAB_MAVEN_URL" \
              -DgeneratePom=true \
              -Dpom.groupId="$groupId" \
              -Dpom.artifactId="$artifactId" \
              -Dpom.version="$version" \
              -s ~/.m2/settings.xml
            
            if [ $? -eq 0 ]; then
              echo "âœ… ä¸Šä¼ æˆåŠŸ: $filename"
            else
              echo "âŒ ä¸Šä¼ å¤±è´¥: $filename"
              echo "âš ï¸  å°è¯•å¤‡ç”¨ä¸Šä¼ æ–¹æ³•..."
              
              # æ–¹æ³•2: ä½¿ç”¨ curl ä½œä¸ºå¤‡ç”¨æ–¹æ¡ˆ
              echo "ğŸ”„ å°è¯•ä½¿ç”¨ curl ä¸Šä¼ ..."
              
              # åˆ›å»ºä¸´æ—¶ pom.xml
              cat > /tmp/temp.pom <<EOF
              <?xml version="1.0" encoding="UTF-8"?>
              <project xmlns="http://maven.apache.org/POM/4.0.0"
                      xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                      xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 
                      http://maven.apache.org/xsd/maven-4.0.0.xsd">
                <modelVersion>4.0.0</modelVersion>
                <groupId>$groupId</groupId>
                <artifactId>$artifactId</artifactId>
                <version>$version</version>
                <packaging>aar</packaging>
              </project>
              EOF
              
              # ä¸Šä¼  AAR æ–‡ä»¶
              echo "ğŸ“¤ ä¸Šä¼  AAR æ–‡ä»¶..."
              curl --silent --show-error --fail --location --request POST \
                "$GITLAB_MAVEN_URL/$groupId/$artifactId/$version/$artifactId-$version.aar" \
                --header "Deploy-Token: $GITLAB_DEPLOY_TOKEN" \
                --header "Content-Type: multipart/form-data" \
                --form "file=@$aar_file"
              
              if [ $? -eq 0 ]; then
                echo "âœ… AAR ä¸Šä¼ æˆåŠŸ"
                
                # ä¸Šä¼  POM æ–‡ä»¶
                echo "ğŸ“¤ ä¸Šä¼  POM æ–‡ä»¶..."
                curl --silent --show-error --fail --location --request POST \
                  "$GITLAB_MAVEN_URL/$groupId/$artifactId/$version/$artifactId-$version.pom" \
                  --header "Deploy-Token: $GITLAB_DEPLOY_TOKEN" \
                  --header "Content-Type: multipart/form-data" \
                  --form "file=@/tmp/temp.pom"
                
                if [ $? -eq 0 ]; then
                  echo "âœ… POM ä¸Šä¼ æˆåŠŸ"
                else
                  echo "âš ï¸  POM ä¸Šä¼ å¤±è´¥ï¼ˆå¯èƒ½å·²å­˜åœ¨ï¼‰"
                fi
                
                # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
                rm -f /tmp/temp.pom
              else
                echo "âŒ curl ä¸Šä¼ ä¹Ÿå¤±è´¥"
              fi
            fi
            
            echo "---"
            
          else
            echo "âš ï¸  è·³è¿‡ä¸åŒ¹é…çš„æ–‡ä»¶: $filename (æ–‡ä»¶åæ ¼å¼ä¸æ­£ç¡®)"
            echo "æœŸæœ›æ ¼å¼: dspread_pos_sdk_ç‰ˆæœ¬å·.aar æˆ– dspread_pos_sdk_ç‰ˆæœ¬å·-min.aar"
            echo "å®é™…æ ¼å¼: $name"
          fi
        done
        
        # æ£€æŸ¥æ˜¯å¦å¤„ç†äº†ä»»ä½•æ–‡ä»¶
        file_count=$(ls "$AAR_DIR"/dspread_pos_sdk_*.aar 2>/dev/null | wc -l)
        if [ "$file_count" -eq 0 ]; then
          echo "âš ï¸  è­¦å‘Š: åœ¨ $AAR_DIR ç›®å½•ä¸‹æœªæ‰¾åˆ° dspread_pos_sdk_*.aar æ–‡ä»¶"
          echo "å½“å‰ç›®å½•å†…å®¹:"
          ls -la "$AAR_DIR"/
        else
          echo "ğŸ‰ POS SDK AAR æ–‡ä»¶å¤„ç†å®Œæˆ"
          echo "ğŸ“Š æ€»å…±æ‰¾åˆ°å¹¶å¤„ç†äº† $file_count ä¸ªæ–‡ä»¶"
        fi
          
  deploy:
    runs-on: ubuntu-latest  # ä½¿ç”¨ Ubuntu ä½œä¸ºè¿è¡Œç¯å¢ƒ
    needs: [build]  # éƒ¨ç½²ä¾èµ–äºæ„å»ºä½œä¸šæˆåŠŸ
    steps:
      - name: Check out repository
        uses: actions/checkout@v2

      - name: Deploy to the server or another location
        run: |
          echo "Deploying APK or other artifacts"
          # å¯ä»¥æ ¹æ®éœ€è¦æ›¿æ¢ä¸ºå®é™…çš„éƒ¨ç½²æ­¥éª¤ï¼Œä¾‹å¦‚ä¸Šä¼ åˆ°æœåŠ¡å™¨æˆ–äº‘å¹³å°ç­‰ 


